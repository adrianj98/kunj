name: Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  label:
    name: Auto Label
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Label PR based on branch
        uses: actions/labeler@v4
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Add size labels
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/XS'
          xs_max_size: '10'
          s_label: 'size/S'
          s_max_size: '100'
          m_label: 'size/M'
          m_max_size: '500'
          l_label: 'size/L'
          l_max_size: '1000'
          xl_label: 'size/XL'
          fail_if_xl: false

  validate:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title follows conventional commits
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert

      - name: Check branch naming convention
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          VALID_PREFIXES="^(feature|bugfix|hotfix|release|docs|test|refactor|chore)/"

          if [[ ! "$BRANCH_NAME" =~ $VALID_PREFIXES ]]; then
            echo "❌ Branch name '$BRANCH_NAME' does not follow naming convention"
            echo "Branch names should start with: feature/, bugfix/, hotfix/, release/, docs/, test/, refactor/, or chore/"
            exit 1
          fi

          echo "✅ Branch name follows convention"

  test-and-lint:
    name: Test and Lint
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Comment test coverage
        uses: ArtiomTr/jest-coverage-report-action@v2
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          skip-step: install
          test-script: npm run test:coverage
          annotations: coverage

  build:
    name: Build Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Check for build artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "❌ Build failed: dist directory not found"
            exit 1
          fi

          if [ ! -f "dist/index.js" ]; then
            echo "❌ Build failed: dist/index.js not found"
            exit 1
          fi

          echo "✅ Build artifacts generated successfully"

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Test CLI commands
        run: |
          echo "Testing kunj CLI commands..."

          # Make executable
          chmod +x dist/index.js

          # Test version command
          node dist/index.js --version

          # Test help command
          node dist/index.js --help

          # Initialize git repo for testing
          git config --global user.email "test@example.com"
          git config --global user.name "Test User"

          # Test list command
          node dist/index.js list || true

          echo "✅ CLI commands executed successfully"